name: Trigger Deploys

on:
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sistema: [sistema-a, sistema-b, sistema-c]

    steps:
      - name: Disparar deploy via repository_dispatch
        id: trigger
        run: |
          echo "Disparando deploy para ${{ matrix.sistema }}"

          start_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"start-deploy", "client_payload": {"sistema": "${{ matrix.sistema }}"}}'

          echo "Aguardando 10s para o deploy aparecer..."
          sleep 10

          echo "Listando execuções recentes do workflow de deploy:"
          gh run list --workflow=deploy.yml --limit 5 --json databaseId,createdAt,status,conclusion,headBranch,url \
            --jq '.[] | {id: .databaseId, criado: .createdAt, status: .status, resultado: .conclusion, url: .url}'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
